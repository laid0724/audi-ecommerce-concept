<div class="checkout-wrapper" *transloco="let translationOutput">
  <div class="aui-layout h-full">
    <div class="aui-grid h-full">
      <div class="aui-cell aui-cell--12 h-full">
        <div class="grid grid-rows-none grid-cols-12 h-full w-full">
          <div class="col-span-12 md:col-span-7 checkout__order-wrapper p-10">
            <a
              [routerLink]="['/', language, 'home']"
              class="w-28 flex items-start justify-center"
            >
              <audi-button type="icon" class="block">
                <img src="assets/audi-logo-black.svg" class="w-full" />
              </audi-button>
            </a>

            <div class="block w-full mb-8">
              <audi-nav-bar class="block my-4" [isSmall]="false">
                <audi-nav-item
                  [isActive]="currentStep === 'info'"
                  (click)="currentStep = 'info'"
                >
                  Your Info
                </audi-nav-item>
                <audi-nav-item
                  [isActive]="currentStep === 'shipping'"
                  [isDisabled]="!step1Complete"
                  (click)="step1Complete ? onSubmitStep1() : null"
                >
                  Shipping Method</audi-nav-item
                >
                <audi-nav-item
                  [isActive]="currentStep === 'payment'"
                  [isDisabled]="!step1Complete || !step2Complete"
                  (click)="
                    step1Complete && step2Complete ? onSubmitStep2() : null
                  "
                >
                  Payment</audi-nav-item
                >
              </audi-nav-bar>
            </div>

            <form [formGroup]="orderForm">
              <ng-container
                *ngTemplateOutlet="
                  step1;
                  context: {
                    $implicit: {
                      formGroup: orderForm,
                      translationOutput
                    }
                  }
                "
              ></ng-container>

              <ng-container
                *ngTemplateOutlet="
                  step2;
                  context: {
                    $implicit: {
                      formGroup: orderForm,
                      translationOutput
                    }
                  }
                "
              ></ng-container>

              <ng-container
                *ngTemplateOutlet="
                  step3;
                  context: {
                    $implicit: {
                      formGroup: orderForm,
                      translationOutput
                    }
                  }
                "
              ></ng-container>
            </form>
          </div>
          <div class="hidden md:block col-span-5 checkout__cart-wrapper p-10">
            <h1 class="aui-headline-2 mt-2">Your Cart</h1>

            <div class="checkout__cart-items">
              <div class="checkout__cart-item" *ngFor="let item of cart">
                <div
                  class="checkout__cart-item__thumbnail"
                  [ngStyle]="{
                    backgroundImage:
                      'url(' + getProductMainPhotoUrl(item.product) + ')'
                  }"
                >
                  <audi-badge class="absolute -top-3 -right-3"
                    >{{ item.quantity }}
                  </audi-badge>
                </div>
                <div class="ml-6 flex flex-col flex-wrap">
                  <small class="aui-small font-bold">{{
                    item.product.name
                  }}</small>
                  <small class="aui-small">{{ item.productSku.sku }}</small>
                </div>
                <small class="aui-small font-bold ml-auto">
                  ${{
                    (getPrice(item.product) * item.quantity).toLocaleString()
                  }}
                </small>
              </div>
            </div>

            <div class="border-t border-color-grey-4 my-4"></div>
            <div class="flex justify-between">
              <small class="aui-small">Subtotal</small>
              <small class="aui-small font-bold"
                >${{ totalPrice.toLocaleString() }}</small
              >
            </div>
            <div class="flex justify-between">
              <small class="aui-small">Shipping</small>
              <small class="aui-small font-bold"
                >${{ orderForm.get('shippingFee')?.value }}</small
              >
            </div>
            <div class="border-t border-color-grey-4 my-4"></div>
            <div class="flex justify-between items-center">
              <small class="aui-small font-bold">Total</small>
              <div class="flex items-center">
                <small class="aui-small mr-2">NTD</small>
                <h6 class="aui-headline-6">
                  ${{ totalPrice.toLocaleString() }}
                </h6>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STEP 1: YOUR INFO -->

<ng-template #step1 let-data>
  <div
    [formGroup]="data.formGroup"
    [ngClass]="{ hidden: currentStep !== 'info' }"
    class="checkout__order-form__step-1"
  >
    <ng-container *ngIf="user == null">
      <audi-control-grid
        class="block mb-8"
        [label]="'Email'"
        [type]="'input'"
        [isInvalid]="
          orderForm.get('email')!.touched && orderForm.get('email')!.invalid
        "
      >
        <ng-container *projectAsFields>
          <div class="aui-fieldset__field">
            <small class="aui-small"
              >Already have an account?
              <a class="aui-textlink" (click)="directToLogin()">Log in</a>
            </small>
            <audi-input-container
              formControlName="email"
              type="email"
              [label]="'Email'"
              [isLightTheme]="false"
              [floatingLabel]="true"
            >
              <audi-control-description>lorem ipsum</audi-control-description>
              <audi-control-valid>lorem ipsum</audi-control-valid>
            </audi-input-container>
          </div>
        </ng-container>

        <audi-control-error [type]="'grid'">required</audi-control-error>
      </audi-control-grid>
    </ng-container>

    <audi-address-fg
      formGroupName="shippingAddress"
      [label]="'Shipping Address'"
      class="block mb-8"
    ></audi-address-fg>

    <audi-control-grid class="block mb-8" [label]="'Notes'" [type]="'input'">
      <ng-container *projectAsFields>
        <div class="aui-fieldset__field">
          <audi-textarea-container
            formControlName="customerNotes"
            [label]="'Notes'"
            [isLightTheme]="false"
          >
            <audi-control-description>lorem ipsum</audi-control-description>
            <audi-control-valid>lorem ipsum</audi-control-valid>
          </audi-textarea-container>
        </div>
      </ng-container>
    </audi-control-grid>

    <audi-button-group class="block mt-8">
      <audi-button type="primary" (click)="onSubmitStep1()"
        >Continue to shipping</audi-button
      >
      <audi-button type="secondary" [routerLink]="['/', language, 'cart']"
        >Return to cart</audi-button
      >
    </audi-button-group>
  </div>
</ng-template>

<!-- STEP 2: SHIPPING METHOD -->

<ng-template #step2 let-data>
  <div
    [formGroup]="data.formGroup"
    [ngClass]="{ hidden: currentStep !== 'shipping' }"
    class="checkout__order-form__step-2"
  >
    <audi-card
      bgColor="white"
      textColor="grey-9"
      [isBordered]="true"
      class="block mb-8"
    >
      <div class="grid grid-rows-none grid-cols-12 items-center">
        <ng-container *ngIf="user == null">
          <div class="col-span-4 text-left pl-4">
            <strong class="aui-caption">Contact Email</strong>
          </div>
          <div class="col-span-4 text-center">
            <small class="aui-small line-clamp-1">{{
              orderForm.get('email')?.value
            }}</small>
          </div>
          <div class="col-span-4 text-right pr-4">
            <a class="aui-caption aui-textlink" (click)="currentStep = 'info'"
              >Change</a
            >
          </div>
          <div class="col-span-12">
            <hr class="my-4" />
          </div>
        </ng-container>
        <div class="col-span-4 text-left pl-4">
          <strong class="aui-caption">Contact Phone</strong>
        </div>
        <div class="col-span-4 text-center">
          <small class="aui-small">{{
            orderForm.get('shippingAddress.phoneNumber')?.value
          }}</small>
        </div>
        <div class="col-span-4 text-right pr-4">
          <a class="aui-caption aui-textlink" (click)="currentStep = 'info'"
            >Change</a
          >
        </div>
        <div class="col-span-12">
          <hr class="my-4" />
        </div>
        <div class="col-span-4 text-left pl-4">
          <strong class="aui-caption">Ship To</strong>
        </div>
        <div class="col-span-4 text-center">
          <small class="aui-small line-clamp-2">{{ shippingAddress }}</small>
        </div>
        <div class="col-span-4 text-right pr-4">
          <a class="aui-caption aui-textlink" (click)="currentStep = 'info'"
            >Change</a
          >
        </div>
      </div>
    </audi-card>

    <audi-control-grid
      class="block mb-10"
      [label]="'Shipping Method'"
      [type]="'input'"
      [isInvalid]="
        orderForm.get('shippingMethod')!.touched &&
        orderForm.get('shippingMethod')!.hasError('required')
      "
    >
      <div class="aui-fieldset__fields mt-8">
        <div
          class="
            aui-fieldset__field
            border border-b-0
            px-7
            py-2
            flex
            items-center
            justify-between
          "
        >
          <audi-radio-container
            class="mb-3"
            formControlName="shippingMethod"
            [label]="'Standard'"
            [value]="'standard'"
          ></audi-radio-container>
          <small class="aui-small italic text-right">
            <span class="block">5-7 Business Days</span>
            <strong>Free</strong>
          </small>
        </div>
      </div>
      <div class="aui-fieldset__fields">
        <div
          class="
            aui-fieldset__field
            border
            px-7
            py-2
            flex
            items-center
            justify-between
          "
        >
          <audi-radio-container
            class="mb-3"
            formControlName="shippingMethod"
            [label]="'Expedited'"
            [value]="'expedited'"
          ></audi-radio-container>
          <small class="aui-small italic text-right">
            <div class="block">1-3 Business Days</div>
            <strong>$200</strong>
          </small>
        </div>
      </div>
      <audi-control-error [type]="'grid'">required</audi-control-error>
    </audi-control-grid>

    <audi-button-group class="block mt-8">
      <audi-button type="primary" (click)="onSubmitStep2()"
        >Continue to payment</audi-button
      >
      <audi-button type="secondary" (click)="currentStep = 'info'"
        >Return to your info</audi-button
      >
    </audi-button-group>
  </div>
</ng-template>

<!-- STEP 3: PAYMENT -->

<ng-template #step3 let-data>
  <div
    [formGroup]="data.formGroup"
    [ngClass]="{ hidden: currentStep !== 'payment' }"
    class="checkout__order-form__step-3"
  >
    <audi-card
      bgColor="white"
      textColor="grey-9"
      [isBordered]="true"
      class="block mb-8"
    >
      <div class="grid grid-rows-none grid-cols-12 items-center">
        <ng-container *ngIf="user == null">
          <div class="col-span-4 text-left pl-4">
            <strong class="aui-caption">Contact Email</strong>
          </div>
          <div class="col-span-4 text-center">
            <small class="aui-small line-clamp-1">{{
              orderForm.get('email')?.value
            }}</small>
          </div>
          <div class="col-span-4 text-right pr-4">
            <a class="aui-caption aui-textlink" (click)="currentStep = 'info'"
              >Change</a
            >
          </div>
          <div class="col-span-12">
            <hr class="my-4" />
          </div>
        </ng-container>
        <div class="col-span-4 text-left pl-4">
          <strong class="aui-caption">Contact Phone</strong>
        </div>
        <div class="col-span-4 text-center">
          <small class="aui-small">{{
            orderForm.get('shippingAddress.phoneNumber')?.value
          }}</small>
        </div>
        <div class="col-span-4 text-right pr-4">
          <a class="aui-caption aui-textlink" (click)="currentStep = 'info'"
            >Change</a
          >
        </div>
        <div class="col-span-12">
          <hr class="my-4" />
        </div>
        <div class="col-span-4 text-left pl-4">
          <strong class="aui-caption">Ship To</strong>
        </div>
        <div class="col-span-4 text-center">
          <small class="aui-small line-clamp-2">{{ shippingAddress }}</small>
        </div>
        <div class="col-span-4 text-right pr-4">
          <a class="aui-caption aui-textlink" (click)="currentStep = 'info'"
            >Change</a
          >
        </div>
        <div class="col-span-12">
          <hr class="my-4" />
        </div>
        <div class="col-span-4 text-left pl-4">
          <strong class="aui-caption">Method</strong>
        </div>
        <div class="col-span-4 text-center">
          <small class="aui-small"
            >{{
              orderForm.get('shippingMethod')?.value
            }}&nbsp;&nbsp;·&nbsp;&nbsp;${{
              orderForm.get('shippingFee')?.value
            }}</small
          >
        </div>
        <div class="col-span-4 text-right pr-4">
          <a class="aui-caption aui-textlink" (click)="currentStep = 'shipping'"
            >Change</a
          >
        </div>
      </div>
    </audi-card>

    <audi-control-grid
      class="block mb-8"
      [label]="'Billing Address'"
      [type]="'input'"
      [isInvalid]="billingAddressFg.touched && billingAddressFg.invalid"
    >
      <ng-container *projectAsFields>
        <div class="aui-fieldset__field">
          <audi-toggle-container
            class="block mt-8"
            formControlName="isSameAddress"
            [labelRight]="'Same as shipping address'"
            [labelLeft]="'Use a different billing address'"
          ></audi-toggle-container>

          <audi-address-fg
            *ngIf="!orderForm.get('isSameAddress')?.value"
            class="block mt-8"
            formGroupName="billingAddress"
          ></audi-address-fg>
        </div>
      </ng-container>
      <audi-control-error [type]="'grid'">required</audi-control-error>
    </audi-control-grid>

    <audi-credit-card-fg
      class="block mb-8"
      formGroupName="creditCard"
      [label]="'Payment Info'"
    ></audi-credit-card-fg>

    <audi-button-group class="block mt-8">
      <audi-button type="primary" (click)="onSubmitOrder()"
        >Submit Order</audi-button
      >
      <audi-button type="secondary" (click)="currentStep = 'shipping'"
        >Return To Shipping Method</audi-button
      >
    </audi-button-group>
  </div>
</ng-template>
